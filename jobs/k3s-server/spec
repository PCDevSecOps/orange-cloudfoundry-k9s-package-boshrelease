---
name: k3s-server

packages:
- k3s
- k9s
- kubectl-k3s
templates:
  config/bpm.yml: config/bpm.yml
  bin/pre-start.erb: bin/pre-start
  bin/post-start.erb: bin/post-start  
  bin/pre-stop.erb: bin/pre-stop
  bin/pre-stop.erb: bin/pre-stop
  bin/post-deploy.erb: bin/post-deploy
  bin/drain.erb: bin/drain
  bin/ctl.erb: bin/ctl
  config/registries.yaml.erb: config/registries.yaml
  config/registry.ca.erb: config/registry.ca
  config/registry.cert.erb: config/registry.cert
  config/registry.key.erb: config/registry.key
  bin/envrc: bin/envrc
  bin/setup-user-env.erb: bin/setup-user-env
  bin/k3s-killall.sh: bin/k3s-killall.sh


# Documentation https://bosh.io/docs/links.html
# Tutorial      https://gist.github.com/Amit-PivotalLabs/c39528248b8cdc4ba8e347f8aa68abb6
consumes:
- name: k3s-server
  type: k3s-server
  optional: false

provides:
- name: k3s-server
  type: k3s-server

properties:

  containerd_registry:
    description: containerd registry configuration

  registry.mirrors.tls.cert:
    description: private registry certificate

  registry.mirrors.tls.key:
    description: private registry private key

  registry.mirrors.tls.ca:
    description: private registry ca

  k3s.v:
    description: "(logging) Number for the log level verbosity (default: 0)"
    default: 0
  k3s.bind-address value:
    description: "(listener) k3s bind address (default: 0.0.0.0)"
    default: 0.0.0.0
  k3s.flannel-backend:                    
    description: (networking) One of 'none', 'vxlan', 'ipsec', or 'wireguard'
    default: vxlan
  k3s.token:
    description: (cluster) Shared secret used to join a server or agent to a cluster [$K3S_TOKEN]
  k3s.node-label:
    description: (agent/node) Registering and starting kubelet with set of labels
    default: ""
  k3s.node-taint: 
    description: (agent/node) Registering kubelet with set of taints
    default: ""

  k3s.kubelet-arg: 
    description: (agent/flags) Customized flag for kubelet process
    default: ""

  k3s.drain.delete-local-data:
    description:  continue even if there are pods using emptyDir (local data that will be deleted when the node is drained).
    default: false

  k3s.drain.disable-eviction: 
    description: force drain to use delete, even if eviction is supported. This will bypass checking PodDisruptionBudgets, use with caution
    default: false

  k3s.drain.grace-period:
    description: period of time in seconds given to each pod to terminate gracefully. If negative, the default value specified in the pod will be used.
    default: -1

  k3s.drain.ignore-daemonsets:
    description: Ignore DaemonSet-managed pods.
    default: true


  k3s.drain.skip-wait-for-delete-timeout:
    description: If pod DeletionTimestamp older than N seconds, skip waiting for the pod. Seconds must be greater than 0 to skip.
    default: 0

  k3s.drain.timeout:
    description: The length of time to wait before giving up, zero means infinite
    default: 0

  k3s.drain.pod-selector: #Not implemented
    description:  Label selector to filter pods on the node

  k3s.drain.selector:  #Not implemented
    description: Selector (label query) to filter on

#done    
#   -v value                                   (logging) Number for the log level verbosity (default: 0)
#   --bind-address value                       (listener) k3s bind address (default: 0.0.0.0)
#   --flannel-backend value                    (networking) One of 'none', 'vxlan', 'ipsec', or 'wireguard' (default: "vxlan")
#   --token value, -t value                    (cluster) Shared secret used to join a server or agent to a cluster [$K3S_TOKEN]

#todo
#   --tls-san value                            (listener) Add additional hostname or IP as a Subject Alternative Name in the TLS cert

#   --kube-apiserver-arg value                 (flags) Customized flag for kube-apiserver process
#   --kube-scheduler-arg value                 (flags) Customized flag for kube-scheduler process
#   --kube-controller-manager-arg value        (flags) Customized flag for kube-controller-manager process
#   --kube-cloud-controller-manager-arg value  (flags) Customized flag for kube-cloud-controller-manager process
#   --datastore-endpoint value                 (db) Specify etcd, Mysql, Postgres, or Sqlite (default) data source name [$K3S_DATASTORE_ENDPOINT]
#   --datastore-cafile value                   (db) TLS Certificate Authority file used to secure datastore backend communication [$K3S_DATASTORE_CAFILE]
#   --datastore-certfile value                 (db) TLS certification file used to secure datastore backend communication [$K3S_DATASTORE_CERTFILE]
#   --datastore-keyfile value                  (db) TLS key file used to secure datastore backend communication [$K3S_DATASTORE_KEYFILE]
#   --node-name value                          (agent/node) Node name [$K3S_NODE_NAME]
#   --with-node-id                             (agent/node) Append id to node name
#   --docker                                   (agent/runtime) Use docker instead of containerd
#   --node-ip value, -i value                  (agent/networking) IP address to advertise for node
#   --node-external-ip value                   (agent/networking) External IP address to advertise for node
#   --kubelet-arg value                        (agent/flags) Customized flag for kubelet process
#   --kube-proxy-arg value                     (agent/flags) Customized flag for kube-proxy process

