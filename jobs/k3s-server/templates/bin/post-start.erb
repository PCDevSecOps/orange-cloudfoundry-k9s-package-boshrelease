#!/bin/bash

#prepare kubeconfig for remote access 
cat /var/vcap/store/k3s-server/k3s.yaml |sed -r 's/(\b[0-9]{1,3}\.){3}[0-9]{1,3}\b'/"<%= spec.ip %>"/ > /var/vcap/store/k3s-server/kubeconfig.yml

<% if_p('k3s.master_vip_api') do |vip| %>
cat /var/vcap/store/k3s-server/k3s.yaml |sed -r 's/(\b[0-9]{1,3}\.){3}[0-9]{1,3}\b'/"<%= vip %>"/ > /var/vcap/store/k3s-server/kubeconfig.yml
<% end %>

#uncordon
/var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/store/k3s-server/kubeconfig.yml uncordon <%= spec.name %>-<%= spec.index %>

#wait for k8s api to be available, wait for 2 min max
<% if_p('k3s.master_vip_api') do |vip| %>
timeout 120 sh -c 'until nc -z <%= vip %> 6443; do sleep 1; done' /var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/store/k3s-server/kubeconfig.yml get pods --all-namespaces
<% else %>
timeout 120 sh -c 'until nc -z localhost 6443; do sleep 1; done' /var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/store/k3s-server/kubeconfig.yml get pods --all-namespaces
<% end %>


