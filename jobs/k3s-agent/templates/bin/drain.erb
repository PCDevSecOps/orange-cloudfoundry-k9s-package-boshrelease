#!/bin/bash

export JOB_DIR=/var/vcap/sys/log/k3s-agent

<% if_p('k3s.drain.kubeconfig') do |kubeconfig| %>
#create local kubeconfig
cat - > /var/vcap/data/k3s-agent/drain-kubeconfig.yaml <<EOF
<%= kubeconfig %>
EOF

#cordon
/var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/data/k3s-agent/drain-kubeconfig.yaml cordon <%= spec.name %>-<%= spec.index %> \
>> $JOB_DIR/drain.log \
2>> $JOB_DIR/drain-stderr.log


#drain
/var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/data/k3s-agent/drain-kubeconfig.yaml drain <%= spec.name %>-<%= spec.index %> \
--delete-emptydir-data=<%= p('k3s.drain.delete-emptydir-data') %> \
--disable-eviction=<%= p('k3s.drain.disable-eviction') %> \
--grace-period=<%= p('k3s.drain.grace-period') %> \
--ignore-daemonsets=<%= p('k3s.drain.ignore-daemonsets') %> \
--skip-wait-for-delete-timeout=<%= p('k3s.drain.skip-wait-for-delete-timeout') %> \
--timeout=<%= p('k3s.drain.timeout') %> \
>> $JOB_DIR/drain.log \
2>> $JOB_DIR/drain-stderr.log

<% end %>


echo 0; exit 0
